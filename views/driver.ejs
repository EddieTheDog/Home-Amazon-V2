<div class="card">
  <h1>Driver</h1>
  <label>Scan or Enter Tracking Number:</label>
  <input type="text" id="trackingInput">
  <button onclick="loadPackage()">Load</button>
</div>

<div id="packageDetails" class="card" style="display:none;">
  <h2>Package Details</h2>
  <pre id="details"></pre>
  <button onclick="claim()">Claim for Delivery</button>
  <button onclick="deliver()">Mark Delivered</button>
  <input type="file" id="proofPhoto" accept="image/*">
  <input type="text" id="proofText" placeholder="Or enter proof text">
</div>

<script>
let currentPkg;

async function loadPackage() {
  const tracking = document.getElementById('trackingInput').value;
  const res = await fetch(`/api/reservations/${tracking}`);
  if (!res.ok) { alert('Package not found'); return; }
  currentPkg = await res.json();
  document.getElementById('packageDetails').style.display = 'block';
  document.getElementById('details').innerText = JSON.stringify(currentPkg, null, 2);
}

async function claim() {
  if (!currentPkg) return;
  await fetch(`/api/reservations/${currentPkg.id}/claim`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({driverId:'driver1'})});
  alert('Claimed for delivery');
}

async function deliver() {
  if (!currentPkg) return;
  const photoInput = document.getElementById('proofPhoto');
  const text = document.getElementById('proofText').value;
  let proof = {};
  if (photoInput.files[0]) {
    const formData = new FormData();
    formData.append('proofPhoto', photoInput.files[0]);
    await fetch(`/api/reservations/${currentPkg.id}/deliver`, {method:'POST', body: formData});
    alert('Delivered with photo');
  } else if (text) {
    await fetch(`/api/reservations/${currentPkg.id}/deliver`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({proofType:'text', proofValue:text})});
    alert('Delivered with text proof');
  } else {
    alert('No proof provided');
  }
  loadPackage();
}
</script>
